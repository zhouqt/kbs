$Id$
                              水木代码安装指南

    本文由 BBS 水木清华站(http://www.smth.org)系统维护组负责维护，介绍了
smthbbs 在类 Unix 操作系统(包括 Linux、FreeBSD、Solaris 8/9 for X86/SPARC
等)上的编译和安装，主要讨论用完全定制的方式进行安装。欢迎到 BBS 水木清华
站的 BBSMan_Dev 版参与 smthbbs 的讨论。

0. ChangeLog
2004.7.20
  flyriver v1.2.1 更新 libesmtp 的说明，加入常用 configure 参数说明

2004.1.1
  flyriver v1.2 重写这个安装文档

2002.7.31
  COMMAN 加入对 ssh 部分的说明, 修正 pop3s 的说明  

2002.7.27
  KCN v1.1 加入pop3s，ssh部分的说明

2002.6.29
  flyriver v1.0

1. 需要的软件:
zlib                   必须
libesmtp > 0.8         可选
autoconf-2.57          可选      如果从 cvs 下载源代码编译安装则必需
automake-1.6.X         可选      如果从 cvs 下载源代码编译安装则必需
libtool-1.4.X          可选      如果从 cvs 下载源代码编译安装则必需
apache_1.3.X           可选      选择 web 界面支持才需要
  or apache2
php > 4.2.0            可选      选择 web 界面支持才需要
libxml2                可选      选择 web 界面支持才需要
libiconv               可选      选择 web 界面支持才需要
libjpeg                可选      选择 web 界面支持才需要
libpng                 可选      选择 web 界面支持才需要
freetype2              可选      选择 web 界面支持才需要
gd                     可选      选择 web 界面支持才需要
openssl                可选      选择 pop3d 支持 pop3s 才需要
gmp-4.X                可选      选择 ssh 方式支持才需要
mysql                  可选      选择个人文集等功能支持才需要

2. 安装
    本节介绍 smthbbs 的 telnet/ssh/web 方式在类 Unix 操作系统上的安装。注意
本文后面给出的一部分命令需要 root 权限。

2.1 一些约定
    $(BBSHOME)         表示 bbs 的安装目录，缺省为 /home/bbs，在本文中指定为
                       /usr/local/bbs
    $(WWWHOME)         表示 apache 的安装目录，在本文中指定为 /usr/local/www
    $(PHPHOME)         表示 php 的安装目录，在本文中按缺省的 /usr/local
    $(SRCDIR)          表示存放 smthbbs、apache 和 php 源代码的目录，可自己设
                       定一个，例如放在自己 home 目录的某个子目录下

2.2 安装 libesmtp 和 gmp
    libesmtp 建议从源代码编译安装，configure 的时候建议加上 --disable-pthreads
参数，但不加也可以，然后运行 make 和 make install 命令。
    注：从 smthbbs-1.2.1 版本开始，libesmtp 不再是必须安装的了，但如果不使用
libesmtp 的话，则系统中必须安装有 sendmail 程序。

    gmp 可以直接使用操作系统自带的软件包。

2.3 下载 smthbbs、apache 和 php 的代码包
    下载 smthbbs 的源代码有两种方法，一种是通过 cvs 方式获取，另一种是下载每
日更新的 smthbbs-snapshot 代码包。用 cvs 方式下载源代码请参考 doc/README.cvs
文件。把 smthbbs、apache 和 php 的代码包放在 $(SRCDIR) 目录，然后分别解开。

    注意在 site/ 子目录里面有名字为 devel.c 和 devel.h 的文件，这两个文件是站
点定制文件，本文以这两个文件为例子进行讲解。注意验证 devel.h 文件中 BBSUID 和 
BBSGID 与本地系统的 bbs 用户的 uid gid 是否一致，如果不一致请调整到一致。

2.4 安装 apache 和 php
    首先切换目录到 $(SRCDIR)，进入 apache 的源代码目录。为了节省篇幅，下面
直接以命令表示。
          cd apache_1.3.X
          ./configure --prefix=/usr/local/www --enable-module=so
          make
          make install
          
          cd ../php-4.3.X
          ./configure --with-apxs=/usr/local/www/bin/apxs --disable-debug \
             --enable-pic --disable-rpath --enable-inline-optimization \
             --with-dom --with-gd --with-freetype-dir=/usr/lib \
             --with-png-dir --with-iconv --with-jpeg-dir --with-zlib \
             --enable-track-vars
          make
          make install

2.5 安装 smthbbs
    同样切换到 $(SRCDIR) 目录，进入 smthbbs 的源代码目录。

    然后执行下面的一系列命令：
          ./configure --prefix=/usr/local/bbs --enable-site=devel \
              --with-www=/usr/local/www --with-php=/usr/local/include/php \
              --with-mysql --enable-ssh --enable-ssl
          make
          make install
          make install-home
          chown -R bbs:bbs /usr/local/bbs

    注：一些常用 configure 参数说明。
          --enable-site=SITE      告诉 smthbbs 采用名为 SITE.h 和 SITE.c 的站
                                  点定制文件，这两个文件必须放在 site/ 目录
          --with-mysql[=DIR]      让 smthbbs 支持 mysql，DIR 为 mysql 库文件
                                  所在目录，如果不指明则自动检测
          --without-mysql         不让 smthbbs 支持 mysql
          --with-libesmtp[=DIR]   让 smthbbs 支持 libesmtp，DIR 为 libesmt 库
                                  文件所在目录，如果不指明则自动检测
          --without-libesmtp      不让 smthbbs 支持 libesmtp
          --with-www=DIR          设定 smthbbs web 子系统的安装目录，要求 DIR
                                  目录下存在名为 html 或 htdocs 的子目录
          --with-php[=DIR]        让 smthbbs 找到 php 头文件所在目录，如果不
                                  指明 DIR 则自动检测

2.6[不推荐] 将 phpbbslib 放入 php 
    同样切换到 $(SRCDIR) 目录，进入 php 的源代码目录。
          mkdir ext/smth_bbs

    然后将 smthbbs 源代码目录 bbs2www/phplib/ 下的 config.m4、php_smth_bbs.h
和 phpbbslib.c 三个文件复制到 ext/smth_bbs 目录，然后执行：
          ./buildconf --force

2.7[不推荐] 再次编译安装 php
    重复 2.4 节中的步骤即可，但 php 的 configure 命令应改为：
          ./configure --with-apxs=/usr/local/www/bin/apxs --disable-debug \
             --enable-pic --disable-rpath --enable-inline-optimization \
             --with-dom --with-gd --with-freetype-dir=/usr/lib \
             --with-png-dir --with-iconv --with-jpeg-dir --with-zlib \
             --enable-track-vars --enable-smth_bbs

2.8[补充] 如果使用 apache2，步骤 2.4 - 2.7 中需要修改的地方是：
        apache 的 configure 命令改成：
                ./configure --prefix=/usr/local/www --enable-so
        php 的 configure 命令里面的 --with-apxs=/usr/local/www/bin/apxs 改成：
                --with-apxs2=/usr/local/www/bin/apxs


    如果一切顺利，至此 smthbbs、apache 和 php 都已经安装完毕。

    注：我们不推荐执行步骤 2.6 和 2.7，但在某些系统上 (比如 cygwin)，要把
phpbbslib 编译成可以动态执行的模块比较困难，则 2.6 和 2.7 就是必须执行的
步骤了。

3. 运行之前的配置
    本节主要说明 ssh 方式和 web 方式的配置。

3.1 ssh 方式
    请参考 doc/sshbbsd-howto 文件。

3.2 web 方式
    apache 的配置文件为 /usr/local/www/conf/httpd.conf，编辑该文件，加入
        AddType application/x-httpd-php .php

    修改 Port 参数为 80，把 User 和 Group 参数都修改为 bbs。
    请把 KeepAlive 参数设为 Off.
    如果使用 apache2，建议加入 AddDefaultCharset gb2312.

    将 smthbbs 源代码目录 bbs2www/xml 和 bbs2www/html 下的文件复制到
    /usr/local/www/htdocs。

    php 的配置文件可以从 php 源代码目录得到，将 php.ini-dist 复制为
/usr/local/lib/php.ini，然后编辑 php.ini 文件，将 short_open_tag 的值修改为
Off，magic_quotes_gpc 也建议设置成 off。

    如果没有执行上面的 2.6 和 2.7 两个步骤，那么再执行下面两个操作：
    (1) 执行命令
        cd /usr/local/lib/php/extensions
        ln -s /usr/local/www/libexec/bbs/libphpbbslib.so
    (2) 修改 php.ini 文件，将
            extension_dir = ./
        修改为
            extension_dir = /usr/local/lib/php/extensions
        加入一行
            extension=libphpbbslib.so
    (注：以上两个步骤只需在初次安装 smthbbs 时执行。)

4. 运行

4.1 运行 smthbbs
          cd /usr/local/bbs/bin
          ./miscd daemon
          ./bbslogd
          ./bbsd -p 23
          ./sshbbsd

    然后 telnet localhost，注册 SYSOP 和 guest 两个帐号。

4.2 运行 apache
          /usr/local/www/bin/apachectl start

5. 其他
    pop3s的支持在 configure 的时候加上 --with-openssl[=path]，生成的 newpop3d
将自动包含 pop3 和 pop3s 的支持。pop3s 支持需要一个证书，可以用 openssl 生成
并放在 $(BBSHOME)/etc/bbs.crt 和 $(BBSHOME)/etc/bbs.key。

